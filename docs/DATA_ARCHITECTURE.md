# Data Architecture - Single Source of Truth

## Overview

All Atlas Score data flows from a **single source**: `regenerate_kingdoms_with_atlas_score.py`

This prevents discrepancies between different parts of the application showing different scores.

## Data Flow

```
┌────────────────────────────────────────────────────────────────┐
│                    RAW DATA SOURCE                              │
│            data/raw/kvk_results.csv                            │
└─────────────────────────┬──────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│             SINGLE GENERATION SCRIPT                            │
│        regenerate_kingdoms_with_atlas_score.py                 │
│                                                                 │
│  • Calculates Atlas Score using Bayesian Average formula       │
│  • Generates ALL output files in a single run                  │
└─────────────────────────┬──────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   FRONTEND      │ │   API CSV       │ │   API CSV       │
│ kingdoms.json   │ │ kingdoms_       │ │ kingdoms_       │
│                 │ │ summary.csv     │ │ all_kvks.csv    │
│ apps/web/src/   │ │ apps/api/data/  │ │ apps/api/data/  │
│ data/           │ │                 │ │                 │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         ▼                   └─────────┬─────────┘
┌─────────────────┐                    ▼
│   React App     │          ┌─────────────────┐
│ (client-side)   │          │   import_data   │
│                 │          │   .py           │
│ Falls back to   │          │                 │
│ kingdoms.json   │          │ Loads to SQLite │
│ if API fails    │          └────────┬────────┘
└─────────────────┘                   ▼
                             ┌─────────────────┐
                             │   FastAPI       │
                             │   (server-side) │
                             └─────────────────┘
```

## Key Files

| File | Purpose | Generated By |
|------|---------|--------------|
| `apps/web/src/data/kingdoms.json` | Frontend data source | `regenerate_kingdoms_with_atlas_score.py` |
| `apps/api/data/kingdoms_summary.csv` | API database import | `regenerate_kingdoms_with_atlas_score.py` |
| `apps/api/data/kingdoms_all_kvks.csv` | API KvK records | `regenerate_kingdoms_with_atlas_score.py` |

## How to Update Data

When new KvK results are added:

```bash
# 1. Update the raw data
# Edit data/raw/kvk_results.csv with new results

# 2. Regenerate ALL data files (single command)
python3 regenerate_kingdoms_with_atlas_score.py

# 3. Import to API database (if running locally)
cd apps/api
python3 import_data.py

# 4. Deploy (if needed)
# Frontend: npm run build && deploy
# API: Deploy to Render/Railway
```

## ⚠️ DEPRECATED Files

The following files should NOT be used - they may contain outdated formulas:

| File | Status | Notes |
|------|--------|-------|
| `data/processed/kingdoms_summary.csv` | ❌ DEPRECATED | Uses old Wilson Score formula |
| `process_kvks.py` | ❌ DEPRECATED | Replaced by regenerate script |
| `sync_to_api.py` | ❌ DEPRECATED | No longer needed - regenerate does this |

## Atlas Score Display Locations

All these locations use `kingdom.overall_score` from the data - NO recalculation:

- **KingdomProfile.tsx** - Main profile page header
- **KingdomCard.tsx** - Card component on directory/search
- **Leaderboards.tsx** - Ranking lists
- **CompareKingdoms.tsx** - Side-by-side comparison
- **AtlasScoreBreakdown.tsx** - Expandable radar chart section
- **ShareButton.tsx** - Social sharing text
- **Discord Bot** - `/kingdom` command response

## Score Simulator (Separate)

The Score Simulator feature (`ScoreSimulator/simulatorUtils.ts`) has its own calculation function for "what-if" scenarios. This is intentional - it allows users to simulate future KvK outcomes. The simulator:

- Uses `calculateAtlasScoreComprehensive()` for projections
- Shows `currentScore` from `kingdom.overall_score` (stored data)
- Shows `projectedScore` from its calculation (simulation only)

This is NOT a discrepancy - it's a feature for planning.

## Troubleshooting

### "Profile shows different score than card"

1. Check if API is returning stale data from database
2. Run `python3 regenerate_kingdoms_with_atlas_score.py` to regenerate all files
3. Run `cd apps/api && python3 import_data.py` to update database
4. Clear browser cache / localStorage

### "Scores look wrong for a kingdom"

The Atlas Score formula uses Bayesian priors which can produce scores that seem "generous" for kingdoms with poor records. This is by design to handle small sample sizes. If the formula needs adjustment, modify `calculate_atlas_score()` in `regenerate_kingdoms_with_atlas_score.py`.
