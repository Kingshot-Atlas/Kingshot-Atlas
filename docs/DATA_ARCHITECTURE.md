# Data Architecture - Single Source of Truth

## Overview

**Updated 2026-02-01:** The single source of truth is now the **Supabase `kingdoms` table**.

All kingdom stats (including Atlas Score) are calculated via database triggers when `kvk_history` changes. The frontend reads directly from Supabase.

## Current Data Flow (v2 - Supabase Source of Truth)

```
┌────────────────────────────────────────────────────────────────┐
│                 USER SUBMISSION FLOW                            │
│           (Real-time, automatic recalculation)                 │
└─────────────────────────┬──────────────────────────────────────┘
                          │
    User submits KvK → Admin approves
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│              SUPABASE kvk_history TABLE                        │
│   API inserts record via submissions.py                        │
└─────────────────────────┬──────────────────────────────────────┘
                          │
                   DATABASE TRIGGER
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│           recalculate_kingdom_stats() FUNCTION                 │
│                                                                │
│  • Counts prep/battle wins/losses from kvk_history            │
│  • Calculates streaks (current and best)                      │
│  • Calculates recent form (weighted 5 KvKs)                   │
│  • Calls calculate_atlas_score() with Bayesian formula        │
│  • Upserts to kingdoms table                                   │
└─────────────────────────┬──────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│        SUPABASE kingdoms TABLE (SOURCE OF TRUTH)              │
│                                                                │
│  • 1,189 kingdoms with all aggregate stats                    │
│  • Atlas Score pre-calculated and updated automatically        │
│  • RLS enabled: anyone can read                               │
└─────────────────────────┬──────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│              FRONTEND (kingdomsSupabaseService.ts)            │
│                                                                │
│  • Reads from Supabase kingdoms table                         │
│  • Falls back to kingdoms.json if Supabase unavailable        │
│  • All pages show consistent data                             │
└────────────────────────────────────────────────────────────────┘
```

## Legacy Data Flow (Batch Updates)

For bulk data imports or corrections, the original flow still works:

```
┌────────────────────────────────────────────────────────────────┐
│                    RAW DATA SOURCE                              │
│            data/raw/kvk_results.csv                            │
└─────────────────────────┬──────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│             BATCH GENERATION SCRIPT                            │
│        regenerate_kingdoms_with_atlas_score.py                 │
│                                                                 │
│  • Calculates Atlas Score using Bayesian Average formula       │
│  • Generates kingdoms.json (fallback)                          │
│  • NOTE: Supabase is still source of truth for live data       │
└─────────────────────────┬──────────────────────────────────────┘
                          │
                          ▼
┌────────────────────────────────────────────────────────────────┐
│   LOCAL FALLBACK: apps/web/src/data/kingdoms.json             │
│   Used only when Supabase is unavailable                       │
└────────────────────────────────────────────────────────────────┘
```

## Key Files

### Supabase (Source of Truth)
| Table | Purpose | Updated By |
|-------|---------|------------|
| `kingdoms` | Kingdom aggregate stats + Atlas Score | Trigger on `kvk_history` changes |
| `kvk_history` | Individual KvK match records | `submissions.py` on approval |

### Frontend Services
| File | Purpose |
|------|---------|
| `apps/web/src/services/kingdomsSupabaseService.ts` | Fetches from Supabase `kingdoms` table |
| `apps/web/src/services/api.ts` | Orchestrates data loading, uses Supabase as primary |

### Legacy/Fallback Files
| File | Purpose | Generated By |
|------|---------|--------------|
| `apps/web/src/data/kingdoms.json` | Fallback when Supabase unavailable | `regenerate_kingdoms_with_atlas_score.py` |
| `apps/api/data/kingdoms_summary.csv` | Legacy API database import | `regenerate_kingdoms_with_atlas_score.py` |

### Database Functions (Supabase)
| Function | Purpose |
|----------|---------|
| `calculate_atlas_score()` | Bayesian Atlas Score formula |
| `recalculate_kingdom_stats()` | Recalculates all stats for a kingdom |
| `trigger_recalculate_kingdom()` | Trigger that fires on kvk_history changes |

## How to Update Data

When new KvK results are added:

```bash
# 1. Update the raw data
# Edit data/raw/kvk_results.csv with new results

# 2. Regenerate ALL data files (single command)
python3 regenerate_kingdoms_with_atlas_score.py

# 3. Import to API database (if running locally)
cd apps/api
python3 import_data.py

# 4. Deploy (if needed)
# Frontend: npm run build && deploy
# API: Deploy to Render
```

## ⚠️ DEPRECATED Files

The following files should NOT be used - they may contain outdated formulas:

| File | Status | Notes |
|------|--------|-------|
| `data/processed/kingdoms_summary.csv` | ❌ DEPRECATED | Uses old Wilson Score formula |
| `process_kvks.py` | ❌ DEPRECATED | Replaced by regenerate script |
| `sync_to_api.py` | ❌ DEPRECATED | No longer needed - regenerate does this |

## Atlas Score Display Locations

All these locations use `kingdom.overall_score` from the data - NO recalculation:

- **KingdomProfile.tsx** - Main profile page header
- **KingdomCard.tsx** - Card component on directory/search
- **Leaderboards.tsx** - Ranking lists
- **CompareKingdoms.tsx** - Side-by-side comparison
- **AtlasScoreBreakdown.tsx** - Expandable radar chart section
- **ShareButton.tsx** - Social sharing text
- **Discord Bot** - `/kingdom` command response

## Score Simulator (Separate)

The Score Simulator feature (`ScoreSimulator/simulatorUtils.ts`) has its own calculation function for "what-if" scenarios. This is intentional - it allows users to simulate future KvK outcomes. The simulator:

- Uses `calculateAtlasScoreComprehensive()` for projections
- Shows `currentScore` from `kingdom.overall_score` (stored data)
- Shows `projectedScore` from its calculation (simulation only)

This is NOT a discrepancy - it's a feature for planning.

## Troubleshooting

### "Profile shows different score than card"

1. Check if API is returning stale data from database
2. Run `python3 regenerate_kingdoms_with_atlas_score.py` to regenerate all files
3. Run `cd apps/api && python3 import_data.py` to update database
4. Clear browser cache / localStorage

### "Scores look wrong for a kingdom"

The Atlas Score formula uses Bayesian priors which can produce scores that seem "generous" for kingdoms with poor records. This is by design to handle small sample sizes. If the formula needs adjustment, modify `calculate_atlas_score()` in `regenerate_kingdoms_with_atlas_score.py`.
